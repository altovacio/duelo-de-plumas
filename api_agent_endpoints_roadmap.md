# API Endpoint Roadmap: User-Owned AI Agents

This document outlines the required API endpoints for managing user-owned AI Writers and Judges, based on `api_roles_and_features.md` and the workflow defined in `tests/test_ai_agents_e2e.py`. It incorporates findings from the existing backend structure (`backend/app`, `backend/models.py`, `backend/schemas.py`).

**Target Roles:** User, Admin

**Implementation Steps:**

1.  **Models:** Define `UserAIWriter` and `UserAIJudge` tables in `backend/models.py` with necessary fields (name, description, prompts, owner_id FK to users table, timestamps). **Add a `credits` field (e.g., `Integer`, default 0) to the `User` model.**
2.  **Schemas:** 
    * Define Pydantic schemas (e.g., `UserAIWriterCreate`, `UserAIWriterUpdate`, `UserAIWriterRead`) in `backend/schemas.py` or potentially a new `backend/app/schemas/ai_agent_schemas.py`.
    * **Update `UserPublic`, `UserDetail`, `UserMe` schemas to include the `credits` field.**
    * **Define schemas for admin credit management (e.g., `AdminUserCreditUpdate`).**
    * **Define schemas for the new AI action endpoints (request body, response).**
3.  **Router:** Create a new router file `backend/app/routers/ai_agents.py` (if not already done).
4.  **Endpoints:** Implement the CRUD endpoints defined below within `ai_agents.py`. **Implement the new AI action endpoints and credit management endpoints.**
5.  **Dependencies:** Use `Depends(get_db_session)` for database access and `Depends(security.get_current_active_user)` for authentication.
6.  **Authorization:** Inside each endpoint, perform checks: ensure the resource belongs to the `current_user` OR the `current_user` has the `admin` role.
7.  **Main App:** Mount the new router in `backend/main.py`.
8.  **Cascade Delete:** Modify the `delete_user_admin` function in `backend/app/routers/admin.py` to also delete associated `UserAIWriter` and `UserAIJudge` records before deleting the user.

**Common User Agent Data Structure (Conceptual):**
*   `id`: int (Read-only, generated by backend)
*   `name`: str (Required, unique per user/agent type)
*   `description`: str (Optional)
*   `base_prompt`: str (Required, system-defined or admin-set default - likely read-only for users)
*   `personality_prompt`: str (Required, user-defined)
*   `owner_id`: int (Read-only, foreign key to User)
*   `created_at`: datetime (Read-only)
*   `updated_at`: datetime (Read-only)
*   `available_llms`: list[str] (Potentially predefined list user can select from or view)

---

## User & Admin Agent Endpoints (`/ai-writers`, `/ai-judges`)

Implemented in `backend/app/routers/ai_agents.py`. Accessible by authenticated Users (for their own agents) and Admins (for any agent).

### AI Writers (`/ai-writers`)

1.  **`POST /ai-writers` - Create User AI Writer**
    *   **Roles:** User, Admin
    *   **Input Schema:** `UserAIWriterCreate` (`name`, `description`?, `personality_prompt`)
    *   **Output Schema:** `UserAIWriterRead`
    *   **Action:** Creates a new `UserAIWriter` associated with the requesting `current_user`. Admins can potentially create agents associated with themselves or maybe other users (TBD on requirements for admin creation of user-owned agents - assume self for now).
    *   **Status Codes:** 201 Created, 400 Bad Request, 401 Unauthorized, 409 Conflict (name unique per user).

2.  **`GET /ai-writers` - List User AI Writers**
    *   **Roles:** User, Admin
    *   **Input:** Optional query param `user_id` (Admin only)
    *   **Output Schema:** `List[UserAIWriterRead]`
    *   **Action:** 
        *   User: Returns all `UserAIWriter` owned by the `current_user`.
        *   Admin: If `user_id` query param provided, returns agents for that user. If no `user_id`, returns *all* `UserAIWriter` instances.
    *   **Status Codes:** 200 OK, 401 Unauthorized, 403 Forbidden (User trying to use `user_id`).

3.  **`GET /ai-writers/{writer_id}` - View User AI Writer Details**
    *   **Roles:** User, Admin
    *   **Input:** `writer_id` (Path parameter)
    *   **Output Schema:** `UserAIWriterRead`
    *   **Action:** Retrieves the `UserAIWriter`.
        *   User: Requires ownership check.
        *   Admin: Access granted.
    *   **Status Codes:** 200 OK, 401 Unauthorized, 403 Forbidden (User lack of ownership), 404 Not Found.

4.  **`PUT /ai-writers/{writer_id}` - Update User AI Writer**
    *   **Roles:** User, Admin
    *   **Input:** `writer_id` (Path parameter), `UserAIWriterUpdate` schema (fields to update)
    *   **Output Schema:** `UserAIWriterRead`
    *   **Action:** Modifies the `UserAIWriter`.
        *   User: Requires ownership check. Cannot update `base_prompt` or `owner_id`.
        *   Admin: Access granted. Can potentially update more fields like `base_prompt` (TBD).
    *   **Status Codes:** 200 OK, 400 Bad Request, 401 Unauthorized, 403 Forbidden, 404 Not Found, 409 Conflict (name unique per user).

5.  **`DELETE /ai-writers/{writer_id}` - Delete User AI Writer**
    *   **Roles:** User, Admin
    *   **Input:** `writer_id` (Path parameter)
    *   **Output:** None
    *   **Action:** Deletes the `UserAIWriter`.
        *   User: Requires ownership check.
        *   Admin: Access granted.
    *   **Status Codes:** 204 No Content, 401 Unauthorized, 403 Forbidden, 404 Not Found.

### AI Judges (`/ai-judges`)

Endpoints follow the exact same pattern as AI Writers, substituting "Judge" for "Writer", `{judge_id}` for `{writer_id}`, and using `UserAIJudge` models/schemas.

1.  **`POST /ai-judges` - Create User AI Judge**
2.  **`GET /ai-judges` - List User AI Judges**
3.  **`GET /ai-judges/{judge_id}` - View User AI Judge Details**
4.  **`PUT /ai-judges/{judge_id}` - Update User AI Judge**
5.  **`DELETE /ai-judges/{judge_id}` - Delete User AI Judge**

---

## Admin Endpoints for *Global* Agents (`/admin/ai-writers`, `/admin/ai-judges`)

These endpoints in `backend/app/routers/admin.py` remain as is, managing globally available agents created by Admins, using the existing `AIWriter`/`AIJudge` models and associated schemas (e.g., `AIWriterAdminView`).

1.  `GET /admin/ai-writers` - List Global AI Writers
2.  `POST /admin/ai-writers` - Create Global AI Writer
3.  `GET /admin/ai-writers/{writer_id}` - Get Global AI Writer Details
4.  `PUT /admin/ai-writers/{writer_id}` - Update Global AI Writer
5.  `DELETE /admin/ai-writers/{writer_id}` - Delete Global AI Writer
6.  (Similarly for `/admin/ai-judges`)

---

## Credit Management & User Info

### Admin Credit Management

Implemented in `backend/app/routers/admin.py`.

1.  **`PUT /admin/users/{user_id}/credits` - Set/Update User Credits**
    *   **Roles:** Admin
    *   **Input Schema:** `AdminUserCreditUpdate` (e.g., `{"credits": 1000}` or `{"add_credits": 500}`)
    *   **Output Schema:** `UserPublic` (showing updated balance)
    *   **Action:** Finds the user by `user_id`, locks the row, updates their `credits` field based on input schema, creates a `CostLedger` entry for the transaction, and commits. Needs validation (e.g., non-negative credits if setting absolute).
    *   **Status Codes:** 200 OK, 400 Bad Request, 401 Unauthorized, 403 Forbidden, 404 Not Found (User), 500 Internal Server Error.

### User Information Endpoints (Updates)

1.  **`GET /auth/users/me` (Update)**
    *   **Router:** `backend/app/routers/auth.py`
    *   **Output Schema:** `UserMe` (Update this schema to include `credits: int`).
    *   **Action:** Retrieve current user's details, including their credit balance.

2.  **`GET /admin/users/` (Update)**
    *   **Router:** `backend/app/routers/admin.py`
    *   **Output Schema:** `List[UserPublic]` (Update `UserPublic` schema to include `credits: int`).
    *   **Action:** List users, ensuring credit balance is included.

3.  **`GET /admin/users/{user_id}` (Update - If it exists)**
    *   *(Assumption: An endpoint like this might exist or be added for viewing specific user details as admin)*
    *   **Router:** `backend/app/routers/admin.py`
    *   **Output Schema:** `UserDetail` (Update `UserDetail` schema to include `credits: int`).
    *   **Action:** Get specific user details, including credit balance.

--- 

## User-Triggered AI Actions (New Endpoints) [Implemented - Placeholders]

These endpoints allow users to spend credits to execute AI actions. Implemented likely in `backend/app/routers/ai_agents.py` or a dedicated action router.

### AI Writer Action

1.  **`POST /ai-writers/{writer_id}/generate` - Generate Text**
    *   **Roles:** User (Owner of the writer)
    *   **Input Schema:** `AIWriterGenerateRequest` (defines `model_id`, potentially others)
    *   **Output Schema:** `AIWriterGenerateResponse` (contains generated text, `credits_spent`, `remaining_credits`, `cost_ledger_id`, etc.)
    *   **Action:**
        1.  Verify ownership (`writer_id` belongs to `current_user`).
        2.  Lock user row `with_for_update()`.
        3.  (Optional) Estimate potential credit cost and perform pre-check against `user.credits`.
        4.  Execute AI generation call (using selected `model_id` and writer's prompts). **[Placeholder]**
        5.  Calculate actual credit cost based on usage/cost model. **[Placeholder]**
        6.  Verify `user.credits` >= actual cost. Raise 402 Payment Required if insufficient.
        7.  Deduct actual cost from `user.credits`.
        8.  Create `CostLedger` entry logging the transaction details (user, action, change, cost, balance, related entity).
        9.  Commit the transaction.
        10. Return generated text and transaction details.
    *   **Status Codes:** 200 OK, 400 Bad Request, 401 Unauthorized, 402 Payment Required, 403 Forbidden (Not owner), 404 Not Found (Writer), 500/503 Internal Server Error (AI call failed).

### AI Judge Action

1.  **`POST /ai-judges/{judge_id}/evaluate` - Evaluate Contest Submissions**
    *   **Roles:** User (Owner of the judge)
    *   **Input Schema:** `AIJudgeEvaluateRequest` (defines `contest_id`, `model_id`)
    *   **Output Schema:** `AIJudgeEvaluateResponse` (confirms evaluation status, `credits_spent`, `remaining_credits`, `cost_ledger_id`, etc.)
    *   **Action:** (Similar logic to writer action)
        1.  Verify ownership (`judge_id` belongs to `current_user`).
        2.  Lock user row `with_for_update()`.
        3.  (Optional) Estimate potential credit cost and perform pre-check.
        4.  Execute AI evaluation call for the contest. **[Placeholder]**
        5.  Calculate actual credit cost based on total usage/cost model. **[Placeholder]**
        6.  Verify `user.credits` >= actual cost. Raise 402 if insufficient.
        7.  Deduct actual cost from `user.credits`.
        8.  Create `CostLedger` entry.
        9.  Commit the transaction.
        10. Store evaluation results (handled by AI service call).
        11. Return confirmation and transaction details.
    *   **Status Codes:** 200 OK/202 Accepted (if async), 400 Bad Request, 401 Unauthorized, 402 Payment Required, 403 Forbidden, 404 Not Found (Judge/Contest), 500/503 Internal Server Error.

---

-Endpoints for requesting AI actions using user-owned agents (e.g., `/ai-writers/{writer_id}/request-action`). These might live in `ai_agents.py` or a separate action-focused router.
-Admin endpoints for listing, approving, or rejecting user AI action requests. 
+*Admin endpoints for directly triggering AI actions (`POST /admin/contests/.../evaluate`, `POST /admin/contests/.../ai-submission`) may be kept for administrative override/testing, potentially ignoring credit costs.* 
+*Endpoints for users to view their detailed credit consumption history.* 