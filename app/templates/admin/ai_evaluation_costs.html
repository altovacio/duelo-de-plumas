{% extends "admin/layout.html" %}

{% block admin_title %}AI Evaluation Costs{% endblock %}

{% block admin_heading %}Costos de Usos de IA{% endblock %}

{% block head_extra %}
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
<style>
    /* Styling for AI text content */
    .ai-text-content {
        white-space: pre-wrap;       /* Wrap text and preserve line breaks */
        word-wrap: break-word;       /* Break long words to prevent overflow */
        max-height: 70vh;            /* Limit height to 70% of viewport height */
        overflow-y: auto;            /* Add scrollbar if needed */
        font-family: 'Source Sans Pro', sans-serif;
        font-size: 16px;
        line-height: 1.6;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="container-fluid p-0">
    <!-- Prominent Total Cost Display -->
    <div class="mb-4 text-center">
        <h2 class="text-primary">Costo Total: ${{ "%.2f"|format(total_cost) }}</h2>
    </div>
    
    <!-- Cost Summary Table in admin-table style -->
    <h3>Resumen de Costos</h3>
    <table class="admin-table mb-4">
        <thead>
            <tr>
                <th class="text-center">Costo de Jueces</th>
                <th class="text-center">Costo de Escritores</th>
                <th class="text-center">Tokens de Prompt</th>
                <th class="text-center">Tokens de Completion</th>
                <th class="text-center">Total de Tokens</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="text-center">
                    <div class="h4">${{ "%.2f"|format(judge_cost) }}</div>
                </td>
                <td class="text-center">
                    <div class="h4">${{ "%.2f"|format(writer_cost) }}</div>
                </td>
                <td class="text-center">
                    <div class="h4">{{ "{:,}".format(total_prompt_tokens) }}</div>
                </td>
                <td class="text-center">
                    <div class="h4">{{ "{:,}".format(total_completion_tokens) }}</div>
                </td>
                <td class="text-center bg-light">
                    <div class="h4"><strong>{{ "{:,}".format(total_prompt_tokens + total_completion_tokens) }}</strong></div>
                </td>
            </tr>
        </tbody>
    </table>
    
    <!-- Cost Breakdown Chart -->
    <h3>Desglose de Costos por Modelo</h3>
    <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-body">
            <div class="chart-container">
                <canvas id="costChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-3" id="costTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="judges-tab" data-toggle="tab" href="#judges-content" role="tab" aria-controls="judges-content" aria-selected="true">Jueces IA</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="writers-tab" data-toggle="tab" href="#writers-content" role="tab" aria-controls="writers-content" aria-selected="false">Escritores IA</a>
        </li>
    </ul>
    
    <div class="tab-content" id="costTabsContent">
        <!-- Judge Evaluations Tab -->
        <div class="tab-pane fade show active" id="judges-content" role="tabpanel" aria-labelledby="judges-tab">
            <h3>Evaluaciones de Jueces IA</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Juez</th>
                        <th>Modelo</th>
                        <th>Prompt Tokens</th>
                        <th>Completion Tokens</th>
                        <th>Costo</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eval in judge_evaluations %}
                    <tr>
                        <td>{{ eval.id }}</td>
                        <td>{{ eval.judge.username }}</td>
                        <td>{{ eval.ai_model }}</td>
                        <td>{{ "{:,}".format(eval.prompt_tokens) }}</td>
                        <td>{{ "{:,}".format(eval.completion_tokens) }}</td>
                        <td>${{ "%.4f"|format(eval.cost) }}</td>
                        <td>{{ eval.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <a href="{{ url_for('admin.view_ai_evaluation', evaluation_id=eval.id) }}" 
                               class="button-small">
                                Ver Detalles
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Writer Requests Tab -->
        <div class="tab-pane fade" id="writers-content" role="tabpanel" aria-labelledby="writers-tab">
            <h3>Textos Generados por Escritores IA</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Escritor</th>
                        <th>Concurso</th>
                        <th>Modelo</th>
                        <th>Prompt Tokens</th>
                        <th>Completion Tokens</th>
                        <th>Costo</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in writer_requests %}
                    <tr>
                        <td>{{ req.id }}</td>
                        <td>{{ req.ai_writer.name }}</td>
                        <td>
                            <a href="{{ url_for('contest.detail', contest_id=req.contest_id) }}">
                                {{ req.contest.title }}
                            </a>
                        </td>
                        <td>{{ req.ai_model }}</td>
                        <td>{{ "{:,}".format(req.prompt_tokens) }}</td>
                        <td>{{ "{:,}".format(req.completion_tokens) }}</td>
                        <td>${{ "%.4f"|format(req.cost) }}</td>
                        <td>{{ req.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <button type="button" class="button-small" data-toggle="modal" data-target="#aiTextModal{{ req.id }}">
                                Ver Texto
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modals for AI Text -->
{% for req in writer_requests %}
<div class="modal fade" id="aiTextModal{{ req.id }}" tabindex="-1" role="dialog" aria-labelledby="aiTextModalLabel{{ req.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiTextModalLabel{{ req.id }}">Texto Generado por {{ req.ai_writer.name }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre class="ai-text-content">{{ req.response_text }}</pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Get canvas element
        var chartCanvas = document.getElementById('costChart');
        
        // Check if the canvas exists
        if (!chartCanvas) {
            console.error('Chart canvas element not found');
            return;
        }
        
        // Get context
        var ctx = chartCanvas.getContext('2d');
        
        // Get data from template (safely)
        var modelNames = JSON.parse('{{ model_names|tojson|safe }}');
        var modelCostsValues = JSON.parse('{{ model_costs_values|tojson|safe }}');
        
        // Prepare colors for bars
        const colors = modelNames.map((_, index) => {
            // Create a gradient from blue to purple
            const hue = 210 + (index * 15) % 60;
            return `hsla(${hue}, 70%, 60%, 0.7)`;
        });
        
        const borderColors = colors.map(color => color.replace('0.7', '1'));
        
        // Create the chart
        var costChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: modelNames,
                datasets: [{
                    label: 'Costo ($)',
                    data: modelCostsValues,
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.618, // Golden ratio for aesthetics
                layout: {
                    padding: {
                        top: 10,
                        right: 20,
                        bottom: 10,
                        left: 20
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            },
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            },
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        titleFont: {
                            size: 13
                        },
                        bodyFont: {
                            size: 12
                        },
                        callbacks: {
                            label: function(context) {
                                return '$' + context.raw.toFixed(4);
                            }
                        }
                    }
                }
            }
        });
        
        // Set chart container height based on golden ratio
        const chartContainer = document.querySelector('.chart-container');
        const chartWidth = chartContainer.offsetWidth;
        chartContainer.style.height = (chartWidth / 1.618) + 'px';
    } catch (error) {
        console.error('Error creating chart:', error);
    }
});
</script>

{% block scripts %}
<!-- Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function(){
    // Initialize Bootstrap tabs
    $('#costTabs a').on('click', function (e) {
        e.preventDefault();
        $(this).tab('show');
    });
    
    // Initialize modals
    $('.modal').modal({
        show: false
    });
});
</script>
{% endblock %}
{% endblock %} 