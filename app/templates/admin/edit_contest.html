{% extends "base.html" %}

{% block title %}{{ title }} - Duelo de Plumas{% endblock %}

{% block content %}
    <h2>{{ title }}</h2>
    <div class="form-container">
        {# Use form_action variable passed from route #}
        <form action="{{ form_action }}" method="post" novalidate>
            {{ form.hidden_tag() }}
            <p>
                {{ form.title.label }}<br>
                {{ form.title(size=60) }}<br>
                {% for error in form.title.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>
                {{ form.description.label }}<br>
                {{ form.description(rows=5, cols=60) }}<br>
                {% for error in form.description.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>
                {{ form.end_date.label }}<br>
                {# Use datetime-local input type. Note: format must match wtforms format #}
                {{ form.end_date(type="datetime-local", value=form.end_date.data.strftime('%Y-%m-%dT%H:%M') if form.end_date.data else '') }}<br>
                {% for error in form.end_date.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>
                {{ form.required_judges.label }}<br>
                {{ form.required_judges(size=5) }}<br>
                {% for error in form.required_judges.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>
                {{ form.contest_type.label }}<br>
                {{ form.contest_type() }}<br>
                {% for error in form.contest_type.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>
                {{ form.contest_password.label }}<br>
                {{ form.contest_password(size=30) }}<br>
                {% for error in form.contest_password.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>
                {{ form.anonymous_submissions() }} {{ form.anonymous_submissions.label }}<br>
                {% for error in form.anonymous_submissions.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>
                {{ form.status.label }}<br>
                {{ form.status() }}<br>
                {% for error in form.status.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </p>
            <p>
                {{ form.judges.label }}<br>
                <div class="judge-selector">
                    <div class="judges-container">
                        <div class="judge-box ai-judges">
                            <h4>Jueces de IA</h4>
                            <div class="judges-list">
                                {% if form.judges.choices %}
                                    {% for choice in form.judges.choices %}
                                        {% set judge_id, judge_name = choice %}
                                        {% set is_ai_judge = judge_is_ai(judge_id) %}
                                        {% if is_ai_judge %}
                                            <div class="judge-item">
                                                <label>
                                                    <input type="checkbox" name="judges" value="{{ judge_id }}" 
                                                        {% if form.judges.data and judge_id in form.judges.data %}checked{% endif %}> 
                                                    {{ judge_name }}
                                                </label>
                                                
                                                {% if is_ai_judge %}
                                                <div class="ai-model-selector" data-judge-id="{{ judge_id }}" 
                                                     {% if not form.judges.data or judge_id not in form.judges.data %}style="display:none;"{% endif %}>
                                                    <select name="judge_model_{{ judge_id }}" class="form-control">
                                                        <option value="">Seleccionar modelo...</option>
                                                        {% for model in ai_models %}
                                                            {% set model_id, model_name = model.id, model.name %}
                                                            {% set is_selected = judge_model_map and judge_id in judge_model_map and judge_model_map[judge_id] == model_id %}
                                                            {% if not is_selected and model_id == 'claude-3-5-haiku-latest' and not (judge_model_map and judge_id in judge_model_map) %}
                                                                {% set is_selected = True %}
                                                            {% endif %}
                                                            <option value="{{ model_id }}" 
                                                                {% if is_selected %}selected{% endif %}>
                                                                {{ model_name }} ({{ model.input_cost_usd_per_1k_tokens }}$ por 1K tokens)
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <p class="no-judges">No hay jueces de IA disponibles</p>
                                {% endif %}
                            </div>
                            <div class="judge-actions">
                                <a href="{{ url_for('admin.add_ai_judge') }}" target="_blank" class="small-link">+ Agregar Juez de IA</a>
                            </div>
                        </div>
                        
                        <div class="judge-box human-judges">
                            <h4>Jueces Humanos</h4>
                            <div class="judges-list">
                                {% if form.judges.choices %}
                                    {% for choice in form.judges.choices %}
                                        {% set judge_id, judge_name = choice %}
                                        {% set is_ai_judge = judge_is_ai(judge_id) %}
                                        {% if not is_ai_judge %}
                                            <div class="judge-item">
                                                <label>
                                                    <input type="checkbox" name="judges" value="{{ judge_id }}" 
                                                        {% if form.judges.data and judge_id in form.judges.data %}checked{% endif %}> 
                                                    {{ judge_name }}
                                                </label>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <p class="no-judges">No hay jueces humanos disponibles</p>
                                {% endif %}
                            </div>
                            <div class="judge-actions">
                                <a href="{{ url_for('admin.add_judge') }}" target="_blank" class="small-link">+ Agregar Juez Humano</a>
                            </div>
                        </div>
                    </div>
                    
                    <small class="text-muted">
                        Selecciona los jueces que evaluarán este concurso. Los jueces de IA muestran entre paréntesis el modelo que utilizan.
                    </small>
                </div>
            </p>
            <p>{{ form.submit() }} <a href="{{ url_for('admin.list_contests') }}">Cancelar</a></p>
        </form>
    </div>

    <style>
        .judge-selector {
            margin-top: 5px;
        }
        .judges-container {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .judge-box {
            flex: 1;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
        }
        .ai-judges {
            background-color: #f8f4ff;
        }
        .ai-judges h4 {
            color: #8e44ad;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5d8f0;
        }
        .human-judges {
            background-color: #f5f9ff;
        }
        .human-judges h4 {
            color: #3498db;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #d4e5f7;
        }
        .judges-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .judge-item {
            padding: 5px 0;
        }
        .judge-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .judge-item input[type="checkbox"] {
            margin-right: 8px;
        }
        .judge-actions {
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            text-align: center;
        }
        .no-judges {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 15px 0;
        }
        .text-muted {
            color: #6c757d;
            display: block;
            margin-top: 4px;
        }
        .small-link {
            font-size: 13px;
            text-decoration: none;
        }
    </style>

    <script>
        // JavaScript to handle showing/hiding the AI model selector
        document.addEventListener('DOMContentLoaded', function() {
            // Get all checkboxes for AI judges
            const aiJudgeCheckboxes = document.querySelectorAll('.ai-judges input[type="checkbox"]');
            
            // Add event listeners to all AI judge checkboxes
            aiJudgeCheckboxes.forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    const judgeId = this.value;
                    const modelSelector = document.querySelector(`.ai-model-selector[data-judge-id="${judgeId}"]`);
                    
                    if (modelSelector) {
                        if (this.checked) {
                            // Show the model selector when the judge is checked
                            modelSelector.style.display = 'block';
                        } else {
                            // Hide the model selector when the judge is unchecked
                            modelSelector.style.display = 'none';
                        }
                    }
                });
            });
        });
    </script>
{% endblock %} 