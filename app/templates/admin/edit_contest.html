{% extends "base.html" %}

{% block title %}{{ title }} - Duelo de Plumas{% endblock %}

{% block content %}
    <!-- Include Quill.js (open-source MIT licensed rich text editor) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <!-- Include custom CSS for this page -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/edit_contest.css') }}">
    
    <!-- Include configuration file first -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/form_config.js') }}"></script>
    
    <!-- Include custom JavaScript for this page -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/edit_contest.js') }}"></script>
    
    <h2>{{ title }}</h2>
    <div class="form-container">
        {# Use form_action variable passed from route #}
        <form action="{{ form_action }}" method="post" novalidate>
            {{ form.hidden_tag() }}
            
            <!-- Primary Contest Information Section -->
            <div class="form-section">
                <h3 class="section-title">Informaci√≥n Principal</h3>
                <div class="form-field {% if form.title.errors %}has-error{% endif %}">
                    {{ form.title.label(class="required-field") }}<br>
                    {{ form.title(size=60, class="form-input") }}<br>
                    {% for error in form.title.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
                
                <div class="form-field {% if form.description.errors %}has-error{% endif %}">
                    {{ form.description.label(class="required-field") }}<br>
                    <!-- Hidden textarea to store the content -->
                    {{ form.description(rows=5, cols=60, class="form-input hidden-textarea", id="description_textarea") }}<br>
                    <!-- Quill editor container -->
                    <div id="quill-editor" class="rich-text-editor"></div>
                    {% for error in form.description.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Contest Configuration Section -->
            <div class="form-section">
                <h3 class="section-title">Configuraci√≥n del Concurso</h3>
                
                <div class="config-grid">
                    <div class="config-field">
                        <div class="form-field {% if form.end_date.errors %}has-error{% endif %}">
                            {{ form.end_date.label(class="required-field") }}<br>
                            {{ form.end_date(type="datetime-local", value=form.end_date.data.strftime('%Y-%m-%dT%H:%M') if form.end_date.data else '', class="form-input") }}<br>
                            {% for error in form.end_date.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="config-field">
                        <div class="form-field {% if form.contest_type.errors %}has-error{% endif %}">
                            {{ form.contest_type.label(class="required-field") }}<br>
                            {{ form.contest_type(class="form-select") }}<br>
                            {% for error in form.contest_type.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="config-field">
                        <div class="form-field {% if form.status.errors %}has-error{% endif %}">
                            {{ form.status.label(class="required-field") }}<br>
                            {{ form.status(class="form-select") }}<br>
                            {% for error in form.status.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div id="password-field" class="form-field password-container {% if form.contest_password.errors %}has-error{% endif %}" style="display: {{ 'block' if form.contest_type.data == 'private' else 'none' }};">
                    {{ form.contest_password.label(class="required-field") }}<br>
                    <div class="password-input-group">
                        {{ form.contest_password(size=32, placeholder='Comparte esta contrase√±a con participantes y jueces', class="form-input password-input") }}
                        <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                            <i class="password-toggle-icon">üëÅÔ∏è</i>
                        </button>
                    </div>
                    {% for error in form.contest_password.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Judges Section -->
            <div class="form-section">
                <h3 class="section-title">Jueces</h3>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-field {% if form.required_judges.errors %}has-error{% endif %}">
                            {{ form.required_judges.label(class="required-field") }}<br>
                            {{ form.required_judges(size=5, class="form-input") }}<br>
                            {% for error in form.required_judges.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="form-field {% if form.judges.errors %}has-error{% endif %}">
                    <div class="judge-selection-container">
                        <div class="judges-header">
                            <h4>Selecci√≥n de Jueces</h4>
                            <small class="text-muted">
                                Selecciona los jueces que evaluar√°n este concurso
                            </small>
                        </div>
                        
                        <!-- Selected Judges Box -->
                        <div class="selected-judges-container">
                            <h4>Jueces Seleccionados para este Concurso</h4>
                            <div id="selected-judges-list" class="selected-judges-list">
                                <p class="no-selected-judges">No hay jueces seleccionados</p>
                            </div>
                        </div>
                        
                        <div class="judges-container">
                            <!-- AI Judges Box -->
                            <div class="judge-box ai-judges">
                                <h4>Jueces de IA</h4>
                                <div class="judges-list">
                                    {% if form.judges.choices %}
                                        {% for choice in form.judges.choices %}
                                            {% set judge_id, judge_name = choice %}
                                            {% set is_ai_judge = judge_is_ai(judge_id) %}
                                            {% if is_ai_judge %}
                                                <div class="judge-item">
                                                    <label>
                                                        <input type="checkbox" name="judges" value="{{ judge_id }}" 
                                                            {% if form.judges.data and judge_id in form.judges.data %}checked{% endif %}
                                                            class="judge-checkbox ai-judge-checkbox"> 
                                                        {{ judge_name }}
                                                    </label>
                                                    
                                                    <div class="ai-model-selector" data-judge-id="{{ judge_id }}" 
                                                         {% if not form.judges.data or judge_id not in form.judges.data %}style="display:none;"{% endif %}>
                                                        <select name="judge_model_{{ judge_id }}" class="form-select model-select">
                                                            <option value="">Seleccionar modelo...</option>
                                                            {% for model in ai_models %}
                                                                {% set model_id, model_name = model.id, model.name %}
                                                                {% set is_selected = judge_model_map and judge_id in judge_model_map and judge_model_map[judge_id] == model_id %}
                                                                {% if not is_selected and model_id == 'claude-3-5-haiku-latest' and not (judge_model_map and judge_id in judge_model_map) %}
                                                                    {% set is_selected = True %}
                                                                {% endif %}
                                                                <option value="{{ model_id }}" 
                                                                    {% if is_selected %}selected{% endif %}>
                                                                    {{ model_name }} ({{ model.input_cost_usd_per_1k_tokens }}$ por 1K tokens)
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <p class="no-judges">No hay jueces de IA disponibles</p>
                                    {% endif %}
                                </div>
                                <div class="judge-actions">
                                    <a href="{{ url_for('admin.add_ai_judge') }}" target="_blank" class="add-judge-btn">+ Crear nuevo Juez</a>
                                </div>
                            </div>
                            
                            <!-- Human Judges Box -->
                            <div class="judge-box human-judges">
                                <h4>Jueces Humanos</h4>
                                <div class="judges-list">
                                    {% if form.judges.choices %}
                                        {% for choice in form.judges.choices %}
                                            {% set judge_id, judge_name = choice %}
                                            {% set is_ai_judge = judge_is_ai(judge_id) %}
                                            {% if not is_ai_judge %}
                                                <div class="judge-item">
                                                    <label>
                                                        <input type="checkbox" name="judges" value="{{ judge_id }}" 
                                                            {% if form.judges.data and judge_id in form.judges.data %}checked{% endif %}
                                                            class="judge-checkbox human-judge-checkbox"> 
                                                        {{ judge_name }}
                                                    </label>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <p class="no-judges">No hay jueces humanos disponibles</p>
                                    {% endif %}
                                </div>
                                <div class="judge-actions">
                                    <a href="{{ url_for('admin.add_judge') }}" target="_blank" class="add-judge-btn">+ Agregar Juez Humano</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                {{ form.submit(class="submit-btn") }} 
                <a href="{{ url_for('admin.list_contests') }}" class="cancel-link">Cancelar</a>
            </div>
        </form>
    </div>
{% endblock %} 