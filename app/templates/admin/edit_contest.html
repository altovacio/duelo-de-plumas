{% extends "base.html" %}

{% block title %}{{ title }} - Duelo de Plumas{% endblock %}

{% block content %}
    <div class="form-container">
        <h2>{{ title }}</h2>
        {# Use form_action variable passed from route #}
        <form action="{{ form_action }}" method="post" novalidate>
            {{ form.hidden_tag() }}
            
            <!-- Contest Status Section -->
            <div class="status-selector">
                <div class="status-label">{{ form.status.label }}</div>
                <div class="status-buttons">
                    {% for value, label in form.status.choices %}
                        <label class="status-option {% if form.status.data == value or (form.status.data is none and value == 'open') %}selected{% endif %}" for="status-{{ value }}">
                            <input type="radio" name="status" id="status-{{ value }}" value="{{ value }}" 
                                  {% if form.status.data == value or (form.status.data is none and value == 'open') %}checked{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                    {% endfor %}
                </div>
                {% for error in form.status.errors %}
                    <span class="error-message">{{ error }}</span>
                {% endfor %}
            </div>
            
            <!-- Primary Information Section -->
            <div class="form-section">
                <h3 class="form-section-title">Informaci√≥n Principal</h3>
                <div class="field-required">
                    {{ form.title.label }}
                    {{ form.title(size=60, required=true) }}
                    {% for error in form.title.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
                
                <div>
                    {{ form.description.label }}
                    {{ form.description(rows=5, cols=60, id="markdown-editor") }}
                    <small class="text-muted">Soporta formato Markdown para dar estilo al texto.</small>
                    {% for error in form.description.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Contest Configuration Section -->
            <div class="form-section">
                <h3 class="form-section-title">Configuraci√≥n del Concurso</h3>
                
                <div class="field-required date-field-container">
                    {{ form.end_date.label }}
                    {# Ensure the date is converted to local time for the input field #}
                    {% set local_end_date = form.end_date.data.replace(tzinfo=timezone.utc).astimezone(MEXICO_CITY_TZ) if form.end_date.data and MEXICO_CITY_TZ else form.end_date.data %}
                    {{ form.end_date(type="datetime-local", value=local_end_date.strftime('%Y-%m-%dT%H:%M') if local_end_date else '', class="date-input") }}
                    {% for error in form.end_date.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
                
                <div class="field-required contest-type-selector">
                    <div class="selector-label">{{ form.contest_type.label }}</div>
                    <div class="selector-buttons">
                        {% for value, label in form.contest_type.choices %}
                            <label class="selector-option {% if form.contest_type.data == value %}selected{% endif %}" for="contest_type-{{ value }}">
                                <input type="radio" name="contest_type" id="contest_type-{{ value }}" value="{{ value }}" 
                                      {% if form.contest_type.data == value %}checked{% endif %}>
                                <span>{{ label }}</span>
                            </label>
                        {% endfor %}
                    </div>
                    {% for error in form.contest_type.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
                
                <div id="password-field" class="{{ 'password-field-visible' if form.contest_type.data == 'private' else 'password-field-hidden' }}">
                    <label for="contest_password" class="form-label">{{ form.contest_password.label.text }}</label>
                    <div class="input-group">
                        {{ form.contest_password(size=32, type="password", placeholder='Comparte esta contrase√±a con participantes y jueces', class="form-control", id="contest_password") }}
                        <button type="button" id="toggle-password" class="btn btn-outline-secondary">
                            <i class="eye-icon">üëÅÔ∏è</i>
                        </button>
                    </div>
                    <small class="text-muted">La contrase√±a se necesita para que participantes y jueces accedan al concurso.</small>
                    {% for error in form.contest_password.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Judges Section -->
            <div class="form-section">
                <h3 class="form-section-title">Jueces del Concurso</h3>
                
                <div class="field-required judge-number-selector">
                    {{ form.required_judges.label }}
                    <div class="number-input-container">
                        <input type="number" name="required_judges" id="required_judges" 
                              min="1" max="9" value="{{ form.required_judges.data }}" required>
                    </div>
                    <small class="text-muted">N√∫mero m√≠nimo de jueces que deben evaluar cada texto (m√°ximo 9).</small>
                    {% for error in form.required_judges.errors %}
                        <span class="error-message">{{ error }}</span>
                    {% endfor %}
                </div>
                
                <div class="judge-selector">
                    <!-- Selected Judges Display -->
                    <div class="selected-judges">
                        <h4>Jueces Seleccionados</h4>
                        <div id="selected-judges-list" class="selected-judges-list">
                            <p class="no-judges-selected" {% if form.judges.data and form.judges.data|length > 0 %}style="display: none;"{% endif %}>
                                No hay jueces seleccionados
                            </p>
                            
                            <!-- Pre-populated selected judges from form data -->
                            {% if form.judges.data and form.judges.data|length > 0 %}
                                {% for judge_id in form.judges.data %}
                                    {% for choice in form.judges.choices %}
                                        {% if choice[0] == judge_id %}
                                            {% set judge_name = choice[1] %}
                                            {% set is_ai = judge_is_ai(judge_id) %}
                                            {% set model_id = judge_model_map[judge_id] if judge_model_map and judge_id in judge_model_map else '' %}
                                            {% set model_name = '' %}
                                            
                                            {% if is_ai and model_id %}
                                                {% for model in ai_models %}
                                                    {% if model.id == model_id %}
                                                        {% set model_name = model.name %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            
                                            <div class="selected-judge-item {{ 'ai' if is_ai else 'human' }}" data-judge-id="{{ judge_id }}">
                                                <span>{{ judge_name }}</span>
                                                {% if is_ai and model_name %}
                                                    <span class="model-name">({{ model_name }})</span>
                                                {% endif %}
                                                <button type="button" class="remove-judge" data-judge-id="{{ judge_id }}">√ó</button>
                                                
                                                <!-- Hidden input to store the selected AI model, if applicable -->
                                                {% if is_ai and model_id %}
                                                    <input type="hidden" name="judge_model_{{ judge_id }}" value="{{ model_id }}">
                                                {% endif %}

                                                <!-- Hidden input for the judge ID -->
                                                <input type="hidden" name="judges" value="{{ judge_id }}">
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="judges-container">
                        <!-- AI Judges Box -->
                        <div class="judge-box ai-judges">
                            <h4>Jueces de IA</h4>
                            <input type="text" id="ai-judge-search" placeholder="Buscar juez de IA..." class="judge-search">
                            <div class="judges-list" id="ai-judges-list">
                                {% if form.judges.choices %}
                                    {% for choice in form.judges.choices %}
                                        {% set judge_id, judge_name = choice %}
                                        {% set is_ai_judge = judge_is_ai(judge_id) %}
                                        {% if is_ai_judge %}
                                            <div class="judge-item" data-judge-name="{{ judge_name|lower }}">
                                                <div class="judge-header">
                                                    <label>
                                                        <input type="checkbox" class="judge-checkbox" value="{{ judge_id }}" 
                                                            {% if form.judges.data and judge_id in form.judges.data %}checked{% endif %}
                                                            data-judge-name="{{ judge_name }}"
                                                            data-judge-type="ai"> 
                                                        {{ judge_name }}
                                                    </label>
                                                </div>
                                                
                                                <div class="ai-model-selector" data-judge-id="{{ judge_id }}" 
                                                     {% if not form.judges.data or judge_id not in form.judges.data %}style="display:none;"{% endif %}>
                                                    <select class="form-control model-select" id="model_select_{{ judge_id }}">
                                                        <option value="">Seleccionar modelo...</option>
                                                        {% for model in ai_models %}
                                                            {% set model_id, model_name = model.id, model.name %}
                                                            {% set is_selected = judge_model_map and judge_id in judge_model_map and judge_model_map[judge_id] == model_id %}
                                                            {% if not is_selected and model_id == 'claude-3-5-haiku-latest' and not (judge_model_map and judge_id in judge_model_map) %}
                                                                {% set is_selected = True %}
                                                            {% endif %}
                                                            <option value="{{ model_id }}" 
                                                                {% if is_selected %}selected{% endif %}
                                                                data-model-name="{{ model_name }}">
                                                                {{ model_name }} ({{ model.input_cost_usd_per_1k_tokens }}$ por 1K tokens)
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <p class="no-judges">No hay jueces de IA disponibles</p>
                                {% endif %}
                            </div>
                            <div class="judge-actions">
                                <a href="{{ url_for('admin.add_ai_judge') }}" target="_blank" class="small-link">+ Crear nuevo Juez</a>
                            </div>
                        </div>
                        
                        <!-- Human Judges Box -->
                        <div class="judge-box human-judges">
                            <h4>Jueces Humanos</h4>
                            <input type="text" id="human-judge-search" placeholder="Buscar juez humano..." class="judge-search">
                            <div class="judges-list" id="human-judges-list">
                                {% if form.judges.choices %}
                                    {% for choice in form.judges.choices %}
                                        {% set judge_id, judge_name = choice %}
                                        {% set is_ai_judge = judge_is_ai(judge_id) %}
                                        {% if not is_ai_judge %}
                                            <div class="judge-item" data-judge-name="{{ judge_name|lower }}">
                                                <div class="judge-header">
                                                    <label>
                                                        <input type="checkbox" class="judge-checkbox" value="{{ judge_id }}" 
                                                            {% if form.judges.data and judge_id in form.judges.data %}checked{% endif %}
                                                            data-judge-name="{{ judge_name }}"
                                                            data-judge-type="human"> 
                                                        {{ judge_name }}
                                                    </label>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <p class="no-judges">No hay jueces humanos disponibles</p>
                                {% endif %}
                            </div>
                            <div class="judge-actions">
                                <a href="{{ url_for('admin.add_judge') }}" target="_blank" class="small-link">+ Agregar Juez Humano</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form Buttons -->
            <div class="form-buttons">
                {{ form.submit(class="submit-btn") }} 
                <a href="{{ url_for('admin.list_contests') }}" class="cancel-button">Cancelar</a>
            </div>
        </form>
    </div>

    <style>
        /* Status selector styling */
        .status-selector {
            margin-bottom: 2rem;
        }
        
        .status-label {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .status-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .status-option {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            padding: 0.5rem 1rem;
            border: 1px solid #ccd4e0;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .status-option input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
        
        .status-option.selected {
            background-color: #ebf5ff;
            border-color: #3498db;
            color: #2980b9;
            font-weight: bold;
        }
        
        /* Date field styling */
        .date-field-container {
            margin-bottom: 1rem;
        }
        
        .date-input {
            max-width: 230px;
            padding: 0.5rem;
            border: 1px solid #ccd4e0;
            border-radius: 4px;
        }
        
        /* Contest type selector styling */
        .contest-type-selector {
            margin-bottom: 1rem;
        }
        
        .selector-label {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .selector-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .selector-option {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            padding: 0.5rem 1rem;
            border: 1px solid #ccd4e0;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .selector-option input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
        
        .selector-option.selected {
            background-color: #ebf5ff;
            border-color: #3498db;
            color: #2980b9;
            font-weight: bold;
        }
        
        /* Password field styling */
        .password-field-hidden {
            display: none;
        }
        .password-field-visible {
            display: block;
        }

        .input-group {
            display: flex;
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-bottom: 0.5rem;
        }
        
        .input-group .form-control {
            flex: 1 1 auto;
            width: 1%;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
            height: 38px;
            box-sizing: border-box;
        }
        
        .input-group .btn {
            padding: 0 0.75rem;
            border: 1px solid #ccd4e0;
            border-radius: 0 4px 4px 0;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 38px;
            box-sizing: border-box;
            min-width: 42px;
        }
        
        .input-group .btn:hover {
            background-color: #e9ecef;
        }
        
        .eye-icon {
            font-style: normal;
            display: inline-block;
            font-size: 18px;
            line-height: 1;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        /* Number input styling */
        .judge-number-selector {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        
        .number-input-container {
            width: 60px;
            margin: 0.5rem 0;
        }
        
        .number-input-container input {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            text-align: center;
            border: 1px solid #ccd4e0;
            border-radius: 4px;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Markdown editor
            const simplemde = new SimpleMDE({
                element: document.getElementById("markdown-editor"),
                spellChecker: false,
                status: ["lines", "words", "cursor"],
                placeholder: "Describe el concurso con detalle. Puedes usar Markdown para dar formato al texto."
            });
            
            // Handle showing/hiding password field based on contest type
            const contestTypeRadios = document.querySelectorAll('input[name="contest_type"]');
            const passwordField = document.querySelector('#password-field');
            
            contestTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    passwordField.classList.toggle('password-field-visible', this.value === 'private');
                    
                    // Update selector option styling
                    document.querySelectorAll('.selector-option').forEach(opt => {
                        if (opt.contains(this)) {
                            opt.classList.add('selected');
                        } else if (opt.querySelector('input[name="contest_type"]')) {
                            opt.classList.remove('selected');
                        }
                    });
                });
            });
            
            // Handle password visibility toggle - directly access elements
            const passwordToggle = document.querySelector('#toggle-password');
            const passwordInput = document.querySelector('#contest_password');
            
            console.log('Password toggle:', passwordToggle);
            console.log('Password input:', passwordInput);
            
            if (passwordToggle && passwordInput) {
                console.log('Setting up password toggle event listener');
                
                passwordToggle.addEventListener('click', function(e) {
                    console.log('Password toggle clicked');
                    e.preventDefault();
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    
                    const eyeIcon = this.querySelector('.eye-icon');
                    if (eyeIcon) {
                        eyeIcon.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí';
                    }
                    
                    console.log('Password type set to:', type);
                });
            }
            
            // Status radio buttons
            document.querySelectorAll('.status-option input').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.status-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to the chosen option
                    if (this.checked) {
                        this.closest('.status-option').classList.add('selected');
                    }
                });
            });
            
            // Judge search functionality
            const setupJudgeSearch = (searchInputId, judgeListId) => {
                const searchInput = document.getElementById(searchInputId);
                const judgeItems = document.querySelectorAll(`#${judgeListId} .judge-item`);
                
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    
                    judgeItems.forEach(item => {
                        const judgeName = item.getAttribute('data-judge-name');
                        if (judgeName.includes(searchTerm)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            };
            
            setupJudgeSearch('ai-judge-search', 'ai-judges-list');
            setupJudgeSearch('human-judge-search', 'human-judges-list');
            
            // ------------------------
            // Judge Selection Management
            // ------------------------
            
            const selectedJudgesList = document.getElementById('selected-judges-list');
            const noJudgesSelectedMsg = document.querySelector('.no-judges-selected');
            
            // Judge management controller
            const judgeManager = {
                // Get all currently selected judges
                getSelectedJudges: function() {
                    return Array.from(selectedJudgesList.querySelectorAll('.selected-judge-item'))
                        .map(item => parseInt(item.dataset.judgeId));
                },
                
                // Add a judge to the selection
                addJudge: function(judgeId, judgeName, judgeType, modelId = null, modelName = null) {
                    // Check if judge is already in the list
                    if (this.getSelectedJudges().includes(parseInt(judgeId))) {
                        if (judgeType === 'ai' && modelId) {
                            this.updateAIJudge(judgeId, modelId, modelName);
                        }
                        return;
                    }
                    
                    // Hide the "no judges" message
                    noJudgesSelectedMsg.style.display = 'none';
                    
                    // Create the judge item
                    const judgeItem = document.createElement('div');
                    judgeItem.classList.add('selected-judge-item');
                    judgeItem.classList.add(judgeType);
                    judgeItem.dataset.judgeId = judgeId;
                    
                    // Build the content
                    let content = `<span>${judgeName}</span>`;
                    if (judgeType === 'ai' && modelName) {
                        content += `<span class="model-name">(${modelName})</span>`;
                    }
                    content += `<button type="button" class="remove-judge" data-judge-id="${judgeId}">√ó</button>`;
                    
                    // Add hidden input for the judge ID
                    content += `<input type="hidden" name="judges" value="${judgeId}">`;
                    
                    // If it's an AI judge, add hidden input for the model
                    if (judgeType === 'ai' && modelId) {
                        content += `<input type="hidden" name="judge_model_${judgeId}" value="${modelId}">`;
                    }
                    
                    judgeItem.innerHTML = content;
                    selectedJudgesList.appendChild(judgeItem);
                    
                    // Add remove event handler
                    const removeBtn = judgeItem.querySelector('.remove-judge');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', () => {
                            this.removeJudge(judgeId);
                        });
                    }
                },
                
                // Remove a judge from the selection
                removeJudge: function(judgeId) {
                    const judgeItem = selectedJudgesList.querySelector(`.selected-judge-item[data-judge-id="${judgeId}"]`);
                    if (judgeItem) {
                        judgeItem.remove();
                    }
                    
                    // Uncheck the corresponding checkbox
                    const checkbox = document.querySelector(`.judge-checkbox[value="${judgeId}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                        
                        // Hide model selector for AI judges
                        if (checkbox.dataset.judgeType === 'ai') {
                            const modelSelector = document.querySelector(`.ai-model-selector[data-judge-id="${judgeId}"]`);
                            if (modelSelector) {
                                modelSelector.style.display = 'none';
                            }
                        }
                    }
                    
                    // Show "no judges" message if no judges are selected
                    if (this.getSelectedJudges().length === 0) {
                        noJudgesSelectedMsg.style.display = 'block';
                    }
                },
                
                // Update an AI judge's model
                updateAIJudge: function(judgeId, modelId, modelName) {
                    const judgeItem = selectedJudgesList.querySelector(`.selected-judge-item[data-judge-id="${judgeId}"]`);
                    if (!judgeItem) return;
                    
                    // Update model name display
                    const modelNameSpan = judgeItem.querySelector('.model-name');
                    if (modelNameSpan) {
                        modelNameSpan.textContent = `(${modelName})`;
                    } else if (modelName) {
                        const nameSpan = judgeItem.querySelector('span');
                        const modelSpan = document.createElement('span');
                        modelSpan.classList.add('model-name');
                        modelSpan.textContent = `(${modelName})`;
                        nameSpan.after(modelSpan);
                    }
                    
                    // Update model ID input
                    let modelInput = judgeItem.querySelector(`input[name="judge_model_${judgeId}"]`);
                    if (modelInput) {
                        modelInput.value = modelId;
                    } else if (modelId) {
                        modelInput = document.createElement('input');
                        modelInput.type = 'hidden';
                        modelInput.name = `judge_model_${judgeId}`;
                        modelInput.value = modelId;
                        judgeItem.appendChild(modelInput);
                    }
                }
            };
            
            // Initialize event handlers for remove buttons
            document.querySelectorAll('.remove-judge').forEach(button => {
                button.addEventListener('click', function() {
                    const judgeId = this.getAttribute('data-judge-id');
                    judgeManager.removeJudge(judgeId);
                });
            });
            
            // Handle checkbox changes
            document.querySelectorAll('.judge-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const judgeId = this.value;
                    const judgeName = this.dataset.judgeName;
                    const judgeType = this.dataset.judgeType;
                    
                    if (this.checked) {
                        if (judgeType === 'ai') {
                            // Show model selector for AI judges
                            const modelSelector = document.querySelector(`.ai-model-selector[data-judge-id="${judgeId}"]`);
                            if (modelSelector) {
                                modelSelector.style.display = 'block';
                                
                                // Get the selected model
                                const modelSelect = document.getElementById(`model_select_${judgeId}`);
                                if (modelSelect && modelSelect.value) {
                                    const modelId = modelSelect.value;
                                    const modelName = modelSelect.options[modelSelect.selectedIndex].dataset.modelName;
                                    judgeManager.addJudge(judgeId, judgeName, judgeType, modelId, modelName);
                                }
                            }
                        } else {
                            // Add human judge immediately
                            judgeManager.addJudge(judgeId, judgeName, judgeType);
                        }
                    } else {
                        // Remove judge when unchecked
                        judgeManager.removeJudge(judgeId);
                    }
                });
            });
            
            // Handle model selection changes
            document.querySelectorAll('.model-select').forEach(select => {
                select.addEventListener('change', function() {
                    const judgeId = this.closest('.ai-model-selector').dataset.judgeId;
                    const checkbox = document.querySelector(`.judge-checkbox[value="${judgeId}"]`);
                    
                    if (checkbox && checkbox.checked) {
                        const judgeName = checkbox.dataset.judgeName;
                        const judgeType = checkbox.dataset.judgeType;
                        const modelId = this.value;
                        const modelName = this.options[this.selectedIndex].dataset.modelName;
                        
                        judgeManager.addJudge(judgeId, judgeName, judgeType, modelId, modelName);
                    }
                });
            });
        });
    </script>
{% endblock %} 
