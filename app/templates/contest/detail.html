{% extends "base.html" %}

{% block title %}{{ title }} - Duelo de Plumas{% endblock %}

{% block content %}
    <article class="contest-detail">
        <h2>{{ contest.title }}</h2>
        <p class="contest-meta">
            Estado: {{ contest.status.capitalize() }} | 
            Tipo: {{ contest.contest_type.capitalize() }} | 
            {% if not is_closed %}
                {% if contest.end_date %}Fecha Límite: {{ contest.end_date.strftime('%d/%m/%Y %H:%M') }} UTC{% else %}Fecha Límite: Indefinida{% endif %}
            {% else %}
                {% if contest.end_date %}Finalizado: {{ contest.end_date.strftime('%d/%m/%Y') }}{% else %}Finalizado (Fecha desconocida){% endif %}
            {% endif %}
        </p>
        <div class="contest-description markdown-content">
            {{ contest.description | markdown | safe }}
        </div>

        <hr>

        {# Show submission block if user can submit OR if contest is in evaluation/closed #}
        {% if can_submit or is_evaluation or is_closed %}
            
            {# Title changes based on state #}
            {% if can_submit %}
                <h3>Enviar tu Texto</h3>
            {% elif is_evaluation %}
                <h3>Evaluación en Progreso</h3>
            {% elif is_closed %}
                <h3>Resultados Finales</h3>
            {% endif %}

            {# Display expiration message if applicable #}
            {% if is_expired %}
                <div class="alert alert-warning">
                    <strong>¡Atención!</strong> Este concurso ha expirado (finalizó el {{ contest.end_date.strftime('%d/%m/%Y %H:%M') }} UTC).
                    {% if current_user.is_authenticated and current_user.is_admin() %}
                         Como administrador, todavía puedes enviar textos.
                    {% else %}
                         Ya no se aceptan nuevos envíos.
                    {% endif %}
                </div>
            {% endif %}
            
            {# Admin: AI Submission Button (Show if admin can submit) #}
            {% if can_submit and current_user.is_authenticated and current_user.is_admin() %}
                <div class="admin-actions">
                    <p><a href="{{ url_for('admin.ai_writer_submission', contest_id=contest.id) }}" class="button">Generar Texto con IA</a></p>
                </div>
            {% endif %}
            
            {# Submission Form (Show only if user can submit) #}
            {% if can_submit %}
                {% if current_user.is_authenticated or true %} {# Placeholder: Decide if login is required #}
                    <div class="form-container">
                        <form action="{{ url_for('contest.detail', contest_id=contest.id) }}" method="post" novalidate>
                            {{ form.hidden_tag() }}
                            <p>
                                {{ form.author_name.label }}<br>
                                {{ form.author_name(size=40) }}<br>
                                {% for error in form.author_name.errors %}
                                    <span style="color: red;">[{{ error }}]</span>
                                {% endfor %}
                            </p>
                            <p>
                                {{ form.title.label }}<br>
                                {{ form.title(size=60) }}<br>
                                {% for error in form.title.errors %}
                                    <span style="color: red;">[{{ error }}]</span>
                                {% endfor %}
                            </p>
                            <p>
                                {{ form.text_content.label }}<br>
                                {{ form.text_content(rows=15, cols=80, id="markdown-editor") }}<br>
                                <small class="text-muted">Soporta formato Markdown para dar estilo al texto.</small><br>
                                {% for error in form.text_content.errors %}
                                    <span style="color: red;">[{{ error }}]</span>
                                {% endfor %}
                            </p>
                            <p>{{ form.submit() }}</p>
                        </form>
                    </div>
                {% else %}
                    <p>Debes <a href="{{ url_for('auth.login', next=request.url) }}">iniciar sesión</a> para enviar un texto.</p>
                {% endif %}
            {# Messages/Actions for Evaluation/Closed states #}
            {% elif is_evaluation %}
                <p>Las sumisiones para este concurso están cerradas. Los resultados se publicarán pronto.</p>
                {# Add link for judges/admins to evaluate #}
                {% if current_user.is_authenticated and (current_user.role == 'judge' or current_user.is_admin()) %}
                    <p><a href="{{ url_for('contest.list_submissions', contest_id=contest.id) }}" class="button">Evaluar Envíos</a></p>
                {% endif %}
            {% elif is_closed %}
                {# Results section goes here - moved inside the main conditional block #}
                {% if submissions_list %}
                    <div class="results-list">
                        {% for submission in submissions_list %}
                            <div class="submission-result-item {% if submission.final_rank %}ranked-submission rank-{{ submission.final_rank }}{% endif %}">
                                <h4>
                                    {% if submission.final_rank == 1 %}
                                        <span class="rank-badge">1º Lugar</span>
                                    {% elif submission.final_rank == 2 %}
                                        <span class="rank-badge">2º Lugar</span>
                                    {% elif submission.final_rank == 3 %}
                                        <span class="rank-badge">3º Lugar</span>
                                    {% elif submission.final_rank == 4 %}
                                        <span class="rank-badge">M. Hon.</span>
                                    {% elif submission.final_rank %}
                                        <span class="rank-badge">{{ submission.final_rank }}º</span>
                                    {% endif %}
                                    "{{ submission.title }}" por {{ submission.author_name }}
                                    <span class="points">({{ submission.total_points }} pts)</span>
                                    {% if submission.is_ai_generated %}
                                        <span class="ai-badge">IA</span>
                                    {% endif %}
                                </h4>
                                
                                {# Submission Metadata - AI Generated? Version info? #}
                                {% if submission.is_ai_generated %}
                                    <div class="submission-metadata">
                                        <p class="ai-info">
                                            Texto generado por IA
                                            {% if submission.ai_writer %}
                                                ({{ submission.ai_writer.name }})
                                            {% endif %}
                                            {% if ai_writing_requests and submission.id in ai_writing_requests %}
                                                - Versión {{ ai_writing_requests[submission.id].app_version }}
                                            {% endif %}
                                        </p>
                                    </div>
                                {% endif %}
                                
                                {# Submission Text Preview and Button #}
                                <div class="submission-text-preview markdown-content">
                                    {{ (submission.text_content[:300] + ('...' if submission.text_content|length > 300 else '')) | markdown | safe }}
                                </div>
                                <button type="button" class="view-full-text-btn button button-small" 
                                        data-submission-id="{{ submission.id }}">
                                    Leer Texto Completo
                                </button>

                                {# Judge Comments #}
                                {% if submission.id in votes_by_submission %}
                                    <div class="judge-comments">
                                        <h5>Comentarios de los Jueces:</h5>
                                        <ul>
                                            {% for vote in votes_by_submission[submission.id] %}
                                                {% if vote.comment %}
                                                    <li>
                                                        <strong>{{ vote.judge.username }}{% if vote.judge.is_ai_judge() %} (IA){% endif %}:</strong> 
                                                        {{ vote.comment }}
                                                        {% if vote.app_version %}
                                                            <span class="vote-version">Versión {{ vote.app_version }}</span>
                                                        {% endif %}
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>
                            {% if not loop.last %}<hr class="submission-divider">{% endif %}
                        {% endfor %}
                    </div>
                    
                    {# Hidden data for JavaScript to read #}
                    <script type="application/json" id="submission-data">
                        {
                            {% for submission in submissions_list %}
                                "{{ submission.id }}": {
                                    "title": {{ submission.title|tojson|safe }},
                                    "author": {{ submission.author_name|tojson|safe }},
                                    "content": {{ submission.text_content|markdown|tojson|safe }}
                                }{% if not loop.last %},{% endif %}
                            {% endfor %}
                        }
                    </script>
                {% else %}
                    <p>No hubo envíos para este concurso.</p>
                {% endif %}
            {% endif %}
        {% else %}
             {# Fallback messages #}
             {% if is_open and is_expired %}
                 {# Specific message for non-admins viewing expired open contests #}
                 <p>Este concurso ha expirado (finalizó el {{ contest.end_date.strftime('%d/%m/%Y %H:%M') }} UTC) y ya no acepta nuevos envíos.</p>
             {% else %}
                 {# Generic fallback for any other unexpected state #}
                 <p>El estado actual del concurso no permite envíos o visualización de resultados.</p>
             {% endif %}
        {% endif %}
    </article>

    {# Modal for Full Text Display #}
    <div id="text-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button type="button" class="modal-close-btn">&times;</button>
            <h3 id="modal-title"></h3>
            <p id="modal-author" class="modal-author-text"></p> {# Added author display #}
            <div id="modal-text" class="markdown-content">
                {# Full text will be injected here by JS #}
            </div>
        </div>
    </div>

    {# Add styling for results and modal #}
    <style>
        .submission-result-item { margin-bottom: 2em; padding: 1em; border: 1px solid #eee; border-radius: 4px; }
        .ranked-submission { border-left: 5px solid #ddd; }
        .rank-1 { border-left-color: gold; }
        .rank-2 { border-left-color: silver; }
        .rank-3 { border-left-color: #cd7f32; } /* Bronze */
        .rank-4 { border-left-color: #aaa; } /* HM */
        .submission-result-item h4 { margin-bottom: 0.5em; }
        .rank-badge { background-color: #eee; color: #333; padding: 0.2em 0.5em; border-radius: 3px; font-size: 0.9em; margin-right: 0.5em; }
        .points { font-weight: normal; color: #555; font-size: 0.9em; }
        .submission-text-preview { 
            margin-top: 1em; 
            margin-bottom: 0.5em; /* Reduced margin */
            max-height: 150px; /* Limit preview height */
            overflow: hidden; /* Hide overflow */
            position: relative; /* Needed for fade effect */
            padding: 10px; 
            border: 1px solid #eee; 
            background-color: #fdfdfd;
        }
        .submission-text-preview::after { /* Optional: Add a fade effect at the bottom */
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, transparent, #fdfdfd);
        }
        .view-full-text-btn {
            margin-bottom: 1em; /* Add margin below button */
        }
        .markdown-content { white-space: normal; word-wrap: break-word; margin: 0; }
        .judge-comments { margin-top: 1em; font-size: 0.9em; }
        .judge-comments h5 { font-size: 1em; margin-bottom: 0.3em; }
        .judge-comments ul { list-style: none; padding-left: 0; margin-left: 0; }
        .judge-comments li { background-color: #f5f5f5; border-left: 3px solid #ccc; padding: 0.5em; margin-bottom: 0.5em; }
        .submission-divider { border: 0; height: 1px; background-color: #eee; margin: 2em 0; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Ensure modal is on top */
            overflow-y: auto; /* Allow modal itself to scroll if content overflows */
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 5px;
            width: 80%;
            max-width: 900px;
            max-height: 90vh; /* Limit height */
            overflow-y: auto; /* Allow content inside modal to scroll */
            position: relative; /* For close button positioning */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #666;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        #modal-title {
            margin-top: 0;
            margin-bottom: 5px; /* Space below title */
            color: #333;
        }
        .modal-author-text {
            font-style: italic;
            color: #555;
            margin-bottom: 15px; /* Space below author */
        }
        #modal-text {
            margin-top: 15px;
        }

        .submission-metadata { margin: 0.5em 0; font-size: 0.9em; color: #555; }
        .ai-info { display: inline-flex; align-items: center; background-color: #f5f5f5; padding: 0.3em 0.6em; border-radius: 3px; }
        .ai-badge { display: inline-block; background-color: #6c757d; color: white; font-size: 0.75em; padding: 0.2em 0.5em; border-radius: 3px; margin-left: 0.5em; font-weight: bold; }
        .vote-version { font-size: 0.8em; color: #777; margin-left: 0.5em; }
    </style>

    {# Modal JavaScript #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('text-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalAuthor = document.getElementById('modal-author'); 
        const modalText = document.getElementById('modal-text');
        const closeBtn = modal.querySelector('.modal-close-btn');

        // Get submission data from the hidden JSON script tag
        let submissionData = {};
        try {
            const dataElement = document.getElementById('submission-data');
            if (dataElement) {
                submissionData = JSON.parse(dataElement.textContent);
            }
        } catch (error) {
            console.error('Error parsing submission data:', error);
        }

        document.querySelectorAll('.view-full-text-btn').forEach(button => {
            button.addEventListener('click', function() {
                const submissionId = this.getAttribute('data-submission-id');
                const data = submissionData[submissionId];
                
                if (data) {
                    modalTitle.textContent = data.title;
                    modalAuthor.textContent = 'por ' + data.author;
                    modalText.innerHTML = data.content; // Render pre-formatted markdown
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden'; // Prevent background scroll
                } else {
                    console.error('Submission data not found for ID:', submissionId);
                }
            });
        });

        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = ''; // Restore background scroll
        }

        closeBtn.addEventListener('click', closeModal);

        modal.addEventListener('click', function(event) {
            // Close if clicked on the overlay (background) but not the content itself
            if (event.target === modal) { 
                closeModal();
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && modal.style.display === 'flex') {
                closeModal();
            }
        });

        // Ensure SimpleMDE loads if needed for the submission form
        const editorElement = document.getElementById('markdown-editor');
        if (editorElement) {
            const simplemde = new SimpleMDE({
                element: editorElement,
                spellChecker: false,
                status: ["lines", "words", "cursor"],
                placeholder: "Escribe tu texto aquí. Puedes usar Markdown para dar formato al texto."
            });
        }
    });
    </script>
{% endblock %} 