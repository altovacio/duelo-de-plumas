{% extends "base.html" %}

{% block title %}{{ title }} - Duelo de Plumas{% endblock %}

{% block content %}
    <h2>{{ title }}</h2>
    <p>Concurso: <a href="{{ url_for('contest.detail', contest_id=contest.id) }}">{{ contest.title }}</a></p>
    <p>Instrucciones: Asigna 1er, 2do y 3er lugar (y opcionalmente Mención Honorífica) a los envíos de abajo. Las opciones disponibles dependen del número total de envíos. <strong>Debes asignar exactamente un 1er, un 2do y un 3er lugar si hay suficientes envíos.</strong></p>

    <div class="form-container evaluation-form">
        <form action="{{ url_for('contest.evaluate_contest', contest_id=contest.id) }}" method="post" novalidate>
            {{ form.hidden_tag() }}

            <table class="evaluation-table admin-table">
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Texto (Vista Previa)</th>
                        <th>Lugar</th>
                        <th>Comentario</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub_form in form.submissions %}
                        {% set submission = submissions | selectattr('id', 'equalto', sub_form.submission_id.data | int) | first %}
                        <tr>
                            {{ sub_form.submission_id(style="display: none;") }}
                            
                            <td>{{ submission.title if submission else 'Error' }}</td>
                            <td class="text-preview-cell">
                                <div class="submission-text-preview">
                                    {{ (submission.text_content[:100] + '...' if submission.text_content|length > 100 else submission.text_content)|markdown|safe if submission else 'Error' }}
                                </div>
                                <button type="button" class="view-full-text-btn button-small" 
                                        data-submission-id="{{ submission.id if submission else '0' }}">
                                    Ver Texto Completo
                                </button>
                            </td>
                            <td>{{ sub_form.place() }}</td>
                            <td>
                                <textarea id="{{ sub_form.comment.id }}" name="{{ sub_form.comment.name }}" rows="2" class="evaluation-comment">{{ sub_form.comment.data or '' }}</textarea>
                                {% for error in sub_form.comment.errors %}
                                    <span style="color: red;">[{{ error }}]</span>
                                {% endfor %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <p class="form-buttons">
                {{ form.submit() }}
                <a href="{{ url_for('contest.list_submissions', contest_id=contest.id) }}" class="cancel-button">Cancelar</a>
            </p>
        </form>
    </div>

    {# Hidden data for JavaScript to read #}
    <script type="application/json" id="submission-data">
        {
            {% for submission in submissions %}
                "{{ submission.id }}": {
                    "title": {{ submission.title|tojson|safe }},
                    "content": {{ submission.text_content|markdown|tojson|safe }}
                }{% if not loop.last %},{% endif %}
            {% endfor %}
        }
    </script>

    <div id="text-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button type="button" class="modal-close-btn">&times;</button>
            <h3 id="modal-title"></h3>
            <div id="modal-text" class="markdown-content">
                {# Full text will be injected here by JS #}
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('text-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const closeBtn = modal.querySelector('.modal-close-btn');

        // Get submission data from the hidden JSON script tag
        let submissionData = {};
        try {
            const dataElement = document.getElementById('submission-data');
            if (dataElement) {
                submissionData = JSON.parse(dataElement.textContent);
            }
        } catch (error) {
            console.error('Error parsing submission data:', error);
        }

        document.querySelectorAll('.view-full-text-btn').forEach(button => {
            button.addEventListener('click', function() {
                const submissionId = this.getAttribute('data-submission-id');
                const data = submissionData[submissionId];
                
                if (data) {
                    modalTitle.textContent = data.title;
                    modalText.innerHTML = data.content;
                    modal.style.display = 'flex';
                } else {
                    console.error('Submission data not found for ID:', submissionId);
                }
            });
        });

        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && modal.style.display === 'flex') {
                modal.style.display = 'none';
            }
        });
    });
    </script>
{% endblock %} 