{% extends "base.html" %}

{# Macro for other templates to import #}
{% macro contest_list(contests, status_title, is_judge_view=False, now_aware=None, timezone=None) %}
    <section class="contest-section">
        {% if status_title %}<h3 class="section-title">{{ status_title }}</h3>{% endif %}
        {% if contests %}
            <ul class="contest-list">
                {% for contest in contests %}
                    <li class="contest-item {% if contest.contest_type == 'private' %}private-contest{% endif %}">
                        <div class="contest-header">
                            <h4 class="contest-title">
                                {% if is_judge_view %}
                                <a href="{{ url_for('contest.list_submissions', contest_id=contest.id) }}">{{ contest.title }}</a>
                                {% else %}
                                <a href="{{ url_for('contest.detail', contest_id=contest.id) }}">{{ contest.title }}</a>
                                {% endif %}
                                {% if contest.contest_type == 'private' %}<span class="private-badge">Privado</span>{% endif %}
                            </h4>
                        </div>
                        
                        {# Add contest description - new section #}
                        <div class="contest-description">
                            {% if contest.description %}
                                {{ contest.description|truncate(150) }}
                            {% else %}
                                <em>No hay descripci√≥n disponible para este concurso.</em>
                            {% endif %}
                        </div>
                        
                        <div class="contest-meta">
                            {% if contest.status == 'open' %}
                                {# Check if it's expired - Safely #}
                                {% set is_expired = False %}
                                {% if contest.end_date and now_aware and timezone %} {# Ensure dates and timezone exist #}
                                    {% set aware_end_date = contest.end_date.replace(tzinfo=timezone.utc) %}
                                    {% if aware_end_date < now_aware %}
                                        {% set is_expired = True %}
                                    {% endif %}
                                {% endif %}
                                
                                {% if is_expired %}
                                    <span class="meta-date">‚ö†Ô∏è Expirado: {{ contest.end_date|human_date(with_time=True) }} (Estado: Abierto)</span>
                                {% elif contest.end_date %}
                                    <span class="meta-date">üìÖ Fecha L√≠mite: {{ contest.end_date|human_date(with_time=True) }}</span>
                                {% else %}
                                    <span class="meta-date">üìÖ Sin fecha l√≠mite</span>
                                {% endif %}
                            {% elif contest.status == 'evaluation' %}
                                <span class="meta-date">‚è≥ Evaluaci√≥n en progreso ({% if contest.end_date %}Finaliz√≥: {{ contest.end_date|human_date }}{% else %}Indefinido{% endif %})</span>
                             {% elif contest.status == 'closed' %}
                                <span class="meta-date">üìÖ {% if contest.end_date %}Finalizado: {{ contest.end_date|human_date }}{% else %}Finalizado (Fecha desconocida){% endif %}</span>
                            {% endif %}
                            <span class="meta-date"> | Creado: {{ contest.created_at|human_date }}</span>
                            
                            {# Add contest statistics - new section #}
                            <div class="meta-stats">
                                <span class="meta-stat">
                                    <i class="fas fa-users"></i> {{ contest.submissions.count() }} participantes
                                </span>
                                {% if contest.word_limit %}
                                <span class="meta-stat">
                                    <i class="fas fa-align-left"></i> L√≠mite: {{ contest.word_limit }} palabras
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        {# Add quill pen icon to each card #}
                        <img src="{{ url_for('static', filename='images/quill-pen.svg') }}" alt="Quill Pen" class="card-quill">
                        
                        {# Only show results for PUBLIC closed contests #}
                        {% if not is_judge_view and contest.status == 'closed' and contest.contest_type == 'public' %}
                            {% set ranked_submissions = contest.submissions.filter(Submission.final_rank != None).order_by(Submission.final_rank.asc(), Submission.total_points.desc()).all() %}
                            {% if ranked_submissions %}
                                <div class="contest-results">
                                    {% for rank in [1, 2, 3] %}
                                        {% for sub in ranked_submissions %}
                                            {% if sub.final_rank == rank %}
                                                {% if rank == 1 %}
                                                    <div class="result-item">
                                                        <span class="rank">1er Lugar:</span> 
                                                        <span class="submission-title">"{{ sub.title }}"</span> 
                                                        <span class="submission-author">por {{ sub.author_name }}</span>
                                                    </div>
                                                {% elif rank == 2 %}
                                                    <div class="result-item">
                                                        <span class="rank">2do Lugar:</span> 
                                                        <span class="submission-title">"{{ sub.title }}"</span> 
                                                        <span class="submission-author">por {{ sub.author_name }}</span>
                                                    </div>
                                                {% elif rank == 3 %}
                                                    <div class="result-item">
                                                        <span class="rank">3er Lugar:</span> 
                                                        <span class="submission-title">"{{ sub.title }}"</span> 
                                                        <span class="submission-author">por {{ sub.author_name }}</span>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="no-contests">No hay {{ status_title|lower }} actualmente.</p>
        {% endif %}
    </section>
{% endmacro %}

{% block title %}{{ title }} - Duelo de Plumas{% endblock %}

{% block content %}
    <div class="contests-container">
        <h2 class="page-title">{{ title }}</h2>

        {# Section for assigned evaluations (Judges only) #}
        {% if current_user.is_authenticated and current_user.role == 'judge' %}
            <div class="judge-evaluation-section">
                <h3 class="section-title">Mis Evaluaciones Pendientes</h3>
                {% if judge_assigned_evaluations %}
                    <ul class="contest-list">
                        {% for contest in judge_assigned_evaluations %}
                            <li class="contest-item {% if contest.contest_type == 'private' %}private-contest{% endif %}">
                                <div class="contest-header">
                                    <h4 class="contest-title">
                                        <a href="{{ url_for('contest.list_submissions', contest_id=contest.id) }}">{{ contest.title }}</a>
                                        {% if contest.contest_type == 'private' %}<span class="private-badge">Privado</span>{% endif %}
                                    </h4>
                                </div>
                                
                                <div class="contest-description">
                                    {% if contest.description %}
                                        {{ contest.description|truncate(150) }}
                                    {% else %}
                                        <em>No hay descripci√≥n disponible para este concurso.</em>
                                    {% endif %}
                                </div>
                                
                                <div class="contest-meta">
                                    <span class="meta-date">‚è∞ Evaluaci√≥n requerida ({% if contest.end_date %}Finaliz√≥: {{ contest.end_date|human_date }}{% else %}Indefinido{% endif %})</span>
                                    
                                    <div class="meta-stats">
                                        <span class="meta-stat">
                                            <i class="fas fa-users"></i> {{ contest.submissions.count() }} participantes
                                        </span>
                                        {% if contest.word_limit %}
                                        <span class="meta-stat">
                                            <i class="fas fa-align-left"></i> L√≠mite: {{ contest.word_limit }} palabras
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="no-contests">No tienes evaluaciones pendientes.</p>
                {% endif %}
            </div>
            <hr class="section-divider">
        {% endif %}

        {# Use the macro for contests instead of repeating the HTML #}
        {{ contest_list(contests_open, 'Concursos Abiertos', now_aware=aware_now, timezone=timezone) }}
        
        <hr class="section-divider">
        
        {# --- New: Show Expired Open Contests if they exist --- #}
        {% if contests_expired_open %}
            {{ contest_list(contests_expired_open, 'Concursos Expirados (Pendientes de Evaluaci√≥n)', now_aware=aware_now, timezone=timezone) }}
            <hr class="section-divider">
        {% endif %}
        
        {{ contest_list(contests_evaluation, 'Concursos en Evaluaci√≥n', now_aware=aware_now, timezone=timezone) }}
        
        <hr class="section-divider">
        
        {{ contest_list(contests_closed, 'Concursos Finalizados', now_aware=aware_now, timezone=timezone) }}
    </div>
{% endblock %} 