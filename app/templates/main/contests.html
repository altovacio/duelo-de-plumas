{% extends "base.html" %}

{# Macro for other templates to import #}
{% macro contest_list(contests, status_title, is_judge_view=False) %}
    <section class="contest-section">
        {% if status_title %}<h3 class="section-title">{{ status_title }}</h3>{% endif %}
        {% if contests %}
            <ul class="contest-list">
                {% for contest in contests %}
                    <li class="contest-item {% if contest.contest_type == 'private' %}private-contest{% endif %}">
                        <div class="contest-header">
                            <h4 class="contest-title">
                                {% if is_judge_view %}
                                <a href="{{ url_for('contest.list_submissions', contest_id=contest.id) }}">{{ contest.title }}</a>
                                {% else %}
                                <a href="{{ url_for('contest.detail', contest_id=contest.id) }}">{{ contest.title }}</a>
                                {% endif %}
                                {% if contest.contest_type == 'private' %}<span class="private-badge">Privado</span>{% endif %}
                            </h4>
                        </div>
                        <div class="contest-meta">
                            <span class="meta-date">üìÖ Finalizado: {{ contest.end_date.strftime('%d/%m/%Y') }}</span>
                        </div>
                        
                        {% if not is_judge_view and contest.status == 'closed' %}
                            {% set ranked_submissions = contest.submissions.filter(Submission.final_rank != None).order_by(Submission.final_rank.asc(), Submission.total_points.desc()).all() %}
                            {% if ranked_submissions %}
                                <div class="contest-results">
                                    {% for rank in [1, 2, 3] %}
                                        {% for sub in ranked_submissions %}
                                            {% if sub.final_rank == rank %}
                                                {% if rank == 1 %}
                                                    <div class="result-item">
                                                        <span class="rank">1er Lugar:</span> 
                                                        <span class="submission-title">"{{ sub.title }}"</span> 
                                                        <span class="submission-author">por {{ sub.author_name }}</span>
                                                    </div>
                                                {% elif rank == 2 %}
                                                    <div class="result-item">
                                                        <span class="rank">2do Lugar:</span> 
                                                        <span class="submission-title">"{{ sub.title }}"</span> 
                                                        <span class="submission-author">por {{ sub.author_name }}</span>
                                                    </div>
                                                {% elif rank == 3 %}
                                                    <div class="result-item">
                                                        <span class="rank">3er Lugar:</span> 
                                                        <span class="submission-title">"{{ sub.title }}"</span> 
                                                        <span class="submission-author">por {{ sub.author_name }}</span>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="no-contests">No hay concursos en esta categor√≠a.</p>
        {% endif %}
    </section>
{% endmacro %}

{% block title %}{{ title }} - Duelo de Plumas{% endblock %}

{% block content %}
    <div class="contests-container">
        <h2 class="page-title">{{ title }}</h2>

        {# Section for assigned evaluations (Judges only) #}
        {% if current_user.is_authenticated and current_user.role == 'judge' %}
            <div class="judge-evaluation-section">
                <h3 class="section-title">Mis Evaluaciones Pendientes</h3>
                {% if judge_assigned_evaluations %}
                    <ul class="contest-list">
                        {% for contest in judge_assigned_evaluations %}
                            <li class="contest-item {% if contest.contest_type == 'private' %}private-contest{% endif %}">
                                <div class="contest-header">
                                    <h4 class="contest-title">
                                        <a href="{{ url_for('contest.list_submissions', contest_id=contest.id) }}">{{ contest.title }}</a>
                                        {% if contest.contest_type == 'private' %}<span class="private-badge">Privado</span>{% endif %}
                                    </h4>
                                </div>
                                <div class="contest-meta">
                                    <span class="meta-date">‚è∞ Evaluaci√≥n requerida (Finaliz√≥: {{ contest.end_date.strftime('%d/%m/%Y') }})</span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="no-contests">No tienes evaluaciones pendientes.</p>
                {% endif %}
            </div>
            <hr class="section-divider">
        {% endif %}

        {# Open contests section #}
        <section class="contest-section">
            <h3 class="section-title">Concursos Abiertos</h3>
            {% if contests_open %}
                <ul class="contest-list">
                    {% for contest in contests_open %}
                        <li class="contest-item {% if contest.contest_type == 'private' %}private-contest{% endif %}">
                            <div class="contest-header">
                                <h4 class="contest-title">
                                    <a href="{{ url_for('contest.detail', contest_id=contest.id) }}">{{ contest.title }}</a>
                                    {% if contest.contest_type == 'private' %}<span class="private-badge">Privado</span>{% endif %}
                                </h4>
                            </div>
                            <div class="contest-meta">
                                <span class="meta-date">üìÖ Fecha L√≠mite: {{ contest.end_date.strftime('%d/%m/%Y %H:%M') }} UTC</span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="no-contests">No hay concursos abiertos actualmente.</p>
            {% endif %}
        </section>
        <hr class="section-divider">
        
        {# Evaluation contests section #}
        <section class="contest-section">
            <h3 class="section-title">Concursos en Evaluaci√≥n</h3>
            {% if contests_evaluation %}
                <ul class="contest-list">
                    {% for contest in contests_evaluation %}
                        <li class="contest-item {% if contest.contest_type == 'private' %}private-contest{% endif %}">
                            <div class="contest-header">
                                <h4 class="contest-title">
                                    <a href="{{ url_for('contest.detail', contest_id=contest.id) }}">{{ contest.title }}</a>
                                    {% if contest.contest_type == 'private' %}<span class="private-badge">Privado</span>{% endif %}
                                </h4>
                            </div>
                            <div class="contest-meta">
                                <span class="meta-date">‚è≥ Evaluaci√≥n en progreso (Finaliz√≥: {{ contest.end_date.strftime('%d/%m/%Y') }})</span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="no-contests">No hay concursos en evaluaci√≥n actualmente.</p>
            {% endif %}
        </section>
        <hr class="section-divider">
        
        {# Closed contests section #}
        <section class="contest-section">
            <h3 class="section-title">Concursos Finalizados</h3>
            {% if contests_closed %}
                <ul class="contest-list">
                    {% for contest in contests_closed %}
                        <li class="contest-item {% if contest.contest_type == 'private' %}private-contest{% endif %}">
                            <div class="contest-header">
                                <h4 class="contest-title">
                                    <a href="{{ url_for('contest.detail', contest_id=contest.id) }}">{{ contest.title }}</a>
                                    {% if contest.contest_type == 'private' %}<span class="private-badge">Privado</span>{% endif %}
                                </h4>
                            </div>
                            <div class="contest-meta">
                                <span class="meta-date">üìÖ Finalizado: {{ contest.end_date.strftime('%d/%m/%Y') }}</span>
                            </div>
                            
                            {% set ranked_submissions = contest.submissions.filter(Submission.final_rank != None).order_by(Submission.final_rank.asc(), Submission.total_points.desc()).all() %}
                            {% if ranked_submissions %}
                                <div class="contest-results">
                                    {% for rank in [1, 2, 3] %}
                                        {% for sub in ranked_submissions %}
                                            {% if sub.final_rank == rank %}
                                                {% if rank == 1 %}
                                                    <div class="result-item">
                                                        <span class="rank">1er Lugar:</span> 
                                                        <span class="submission-title">"{{ sub.title }}"</span> 
                                                        <span class="submission-author">por {{ sub.author_name }}</span>
                                                    </div>
                                                {% elif rank == 2 %}
                                                    <div class="result-item">
                                                        <span class="rank">2do Lugar:</span> 
                                                        <span class="submission-title">"{{ sub.title }}"</span> 
                                                        <span class="submission-author">por {{ sub.author_name }}</span>
                                                    </div>
                                                {% elif rank == 3 %}
                                                    <div class="result-item">
                                                        <span class="rank">3er Lugar:</span> 
                                                        <span class="submission-title">"{{ sub.title }}"</span> 
                                                        <span class="submission-author">por {{ sub.author_name }}</span>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="no-contests">No hay concursos finalizados.</p>
            {% endif %}
        </section>
    </div>
{% endblock %} 